openapi: 3.0.3
info:
  title: Digital Capability Exchange API
  version: 0.1.0
  description: >
    Digital Capability Exchange (DCX) API.
    Authentication is not enabled yet.

servers:
  - url: https://zhjc3fmm77.execute-api.eu-west-2.amazonaws.com/api
    description: API Gateway (develop)

tags:
  - name: Skills
  - name: Consultancies
  - name: Uploads

paths:
  /v1/skills:
    post:
      tags: [Skills]
      summary: Create a skill
      operationId: createSkill
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateSkill"
            examples:
              example:
                value:
                  name: "React Native"
                  category: "Frontend"
                  aliases: ["RN", "ReactNative"]
      responses:
        "201":
          description: Skill created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateSkillResponse"
              examples:
                created:
                  value:
                    message: "Skill created successfully"
                    skill:
                      skillId: "sk_123e4567-e89b-12d3-a456-426614174000"
                      name: "React Native"
                      category: "Frontend"
                      status: "active"
                      aliases: ["RN", "ReactNative"]
                      createdAt: "2026-01-08T10:00:00.000Z"
                      updatedAt: "2026-01-08T10:00:00.000Z"
        "409":
          description: Skill name conflict
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                conflict:
                  value:
                    message: "A skill with this name already exists."
                    code: "SkillNameConflict"
        "400":
          description: Validation error / invalid payload
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    get:
      tags: [Skills]
      summary: List skills (pagination + filters)
      operationId: getSkills
      parameters:
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
          description: Page number (1-based)
        - in: query
          name: pageSize
          schema: { type: integer, minimum: 1, maximum: 100, default: 25 }
          description: Number of records per page
        - in: query
          name: status
          schema:
            $ref: "#/components/schemas/SkillStatus"
          description: Filter by status (DB CHECK constraint enforced)
        - in: query
          name: category
          schema: { type: string, example: "frontend" }
          description: Filter by category (case-insensitive exact match)
        - in: query
          name: search
          schema: { type: string, example: "react" }
          description: Search by skill name (matches name_lower LIKE %search%)
      responses:
        "200":
          description: Skills list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetSkillsResponse"
              examples:
                page1:
                  value:
                    skills:
                      - skillId: "sk_aaa"
                        name: "Playwright"
                        category: "Testing"
                        status: "active"
                        aliases: []
                        createdAt: "2026-01-08T10:00:00.000Z"
                        updatedAt: "2026-01-08T10:00:00.000Z"
                    meta:
                      page: 1
                      pageSize: 25
                      total: 1
                      totalPages: 1
        "400":
          description: Invalid query params
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /v1/consultancy:
    post:
      tags: [Consultancies]
      summary: Create a consultancy
      operationId: createConsultancy
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateConsultancy"
            examples:
              minimal:
                value:
                  name: "Leighton Digital"
              withLocationAndSkills:
                value:
                  name: "Leighton Digital"
                  aboutUs: "We specialise in modern web apps and platform engineering."
                  website: "https://example.com"
                  location:
                    country: "UK"
                    city: "London"
                    region: "England"
                    timezone: "Europe/London"
                  specialtySkillIds:
                    - "sk_11111111-1111-1111-1111-111111111111"
                    - "sk_22222222-2222-2222-2222-222222222222"
              withLogo:
                value:
                  name: "Leighton Digital"
                  aboutUs: "We specialise in modern web apps and platform engineering."
                  website: "https://example.com"
                  location:
                    country: "UK"
                    city: "London"
                  logo:
                    key: "consultancies/logos/tmp/lo_123/logo.png"
                    url: "https://cdn.example.com/consultancies/logos/tmp/lo_123/logo.png"
                    contentType: "image/png"
      responses:
        "201":
          description: Consultancy created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateConsultancyResponse"
              examples:
                created:
                  value:
                    message: "Consultancy created successfully"
                    createdConsultancy:
                      consultancyId: "co_123e4567-e89b-12d3-a456-426614174000"
                      name: "Leighton Digital"
                      aboutUs: "We specialise in modern web apps and platform engineering."
                      website: "https://example.com"
                      specialtySkillIds:
                        - "sk_11111111-1111-1111-1111-111111111111"
                      status: "active"
                      createdAt: "2026-01-08T10:00:00.000Z"
                      updatedAt: "2026-01-08T10:00:00.000Z"
                      location:
                        country: "UK"
                        city: "London"
                        region: "England"
                        timezone: "Europe/London"
                      logo:
                        key: "consultancies/logos/tmp/lo_123/logo.png"
                        url: "https://cdn.example.com/consultancies/logos/tmp/lo_123/logo.png"
                        contentType: "image/png"
        "400":
          description: Validation error / invalid payload
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                invalidWebsite:
                  value:
                    message: 'must match format "uri"'
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    get:
      tags: [Consultancies]
      summary: List consultancies (pagination + filters)
      operationId: getConsultancies
      parameters:
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
          description: Page number (1-based)
        - in: query
          name: pageSize
          schema: { type: integer, minimum: 1, maximum: 100, default: 25 }
          description: Number of records per page
        - in: query
          name: status
          schema:
            $ref: "#/components/schemas/ConsultancyStatus"
          description: Filter by status (DB CHECK constraint enforced)
        - in: query
          name: country
          schema: { type: string, example: "uk" }
          description: Case-insensitive exact match
        - in: query
          name: city
          schema: { type: string, example: "london" }
          description: Case-insensitive exact match
        - in: query
          name: region
          schema: { type: string, example: "england" }
          description: Case-insensitive exact match
        - in: query
          name: search
          schema: { type: string, example: "leighton" }
          description: Search by consultancy name (name_canonical LIKE %search%)
        - in: query
          name: skillId
          schema:
            { type: string, example: "sk_11111111-1111-1111-1111-111111111111" }
          description: Filter consultancies that have this specialty skillId
      responses:
        "200":
          description: Consultancies list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetConsultanciesResponse"
        "400":
          description: Invalid query params
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /v1/consultancy/logo-upload:
    post:
      tags: [Uploads]
      summary: Request a presigned URL to upload a consultancy logo
      operationId: consultancyLogoUpload
      description: >
        Frontend calls this when a user selects a logo file.
        API returns an uploadUrl and logo metadata to attach to the consultancy payload.
        Client should upload using HTTP PUT to uploadUrl with Content-Type set to contentType.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LogoUploadRequest"
            examples:
              example:
                value:
                  filename: "logo.png"
                  contentType: "image/png"
      responses:
        "200":
          description: Presigned URL issued
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LogoUploadResponse"
              examples:
                ok:
                  value:
                    uploadUrl: "https://signed-s3-url..."
                    key: "consultancies/logos/tmp/lo_123/logo.png"
                    url: "https://cdn.example.com/consultancies/logos/tmp/lo_123/logo.png"
                    contentType: "image/png"
                    expiresIn: 300
        "400":
          description: Validation error / invalid payload
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  schemas:
    # -----------------------
    # Shared
    # -----------------------
    PaginationMeta:
      type: object
      required: [page, pageSize, total, totalPages]
      properties:
        page: { type: integer, minimum: 1 }
        pageSize: { type: integer, minimum: 1, maximum: 100 }
        total: { type: integer, minimum: 0 }
        totalPages: { type: integer, minimum: 1 }

    ErrorResponse:
      type: object
      required: [message]
      properties:
        message: { type: string }
        code: { type: string, nullable: true }

    # -----------------------
    # Skills
    # -----------------------
    SkillStatus:
      type: string
      enum: [active, deprecated]

    CreateSkill:
      type: object
      required: [name, category]
      properties:
        name:
          type: string
          minLength: 1
          example: "React Native"
        category:
          type: string
          minLength: 1
          example: "Frontend"
        aliases:
          type: array
          items: { type: string }
          description: Optional list of alternative names.
          example: ["RN", "ReactNative"]

    Skill:
      type: object
      required: [skillId, name, category, status, aliases, createdAt, updatedAt]
      properties:
        skillId:
          type: string
          example: "sk_123e4567-e89b-12d3-a456-426614174000"
        name:
          type: string
          example: "React Native"
        category:
          type: string
          example: "Frontend"
        status:
          $ref: "#/components/schemas/SkillStatus"
        aliases:
          type: array
          items: { type: string }
          description: Always returned as an array (empty if none supplied).
          example: ["RN", "ReactNative"]
        createdAt:
          type: string
          format: date-time
          example: "2026-01-08T10:00:00.000Z"
        updatedAt:
          type: string
          format: date-time
          example: "2026-01-08T10:00:00.000Z"

    CreateSkillResponse:
      type: object
      required: [message, skill]
      properties:
        message:
          type: string
          example: "Skill created successfully"
        skill:
          $ref: "#/components/schemas/Skill"

    GetSkillsResponse:
      type: object
      required: [skills, meta]
      properties:
        skills:
          type: array
          items: { $ref: "#/components/schemas/Skill" }
        meta:
          $ref: "#/components/schemas/PaginationMeta"

    # -----------------------
    # Consultancies
    # -----------------------
    ConsultancyStatus:
      type: string
      enum: [active, disabled]

    ConsultancyLocation:
      type: object
      description: Optional location. If provided, country and city are required.
      properties:
        country: { type: string, example: "UK" }
        city: { type: string, example: "London" }
        region: { type: string, example: "England" }
        timezone: { type: string, example: "Europe/London" }
      required: [country, city]

    ConsultancyLogo:
      type: object
      description: Optional logo metadata (fields are optional in current validator).
      properties:
        key:
          { type: string, example: "consultancies/logos/tmp/lo_123/logo.png" }
        url:
          type: string
          format: uri
          example: "https://cdn.example.com/consultancies/logos/tmp/lo_123/logo.png"
        contentType: { type: string, example: "image/png" }

    # Request payload (matches your JSON schema)
    CreateConsultancy:
      type: object
      required: [name]
      properties:
        name:
          type: string
          minLength: 1
          example: "Leighton Digital"
        aboutUs:
          type: string
          example: "We specialise in modern web apps and platform engineering."
        website:
          type: string
          format: uri
          description: Must be a valid URI (e.g. https://example.com)
          example: "https://example.com"
        specialtySkillIds:
          type: array
          items: { type: string }
          example: ["sk_11111111-1111-1111-1111-111111111111"]
        location:
          $ref: "#/components/schemas/ConsultancyLocation"
        logo:
          $ref: "#/components/schemas/ConsultancyLogo"

    # Response DTO (your interface)
    Consultancy:
      type: object
      required:
        - consultancyId
        - name
        - aboutUs
        - website
        - specialtySkillIds
        - status
        - createdAt
        - updatedAt
        - location
      properties:
        consultancyId:
          type: string
          example: "co_123e4567-e89b-12d3-a456-426614174000"
        name:
          type: string
          example: "Leighton Digital"
        aboutUs:
          type: string
          example: "We specialise in modern web apps and platform engineering."
        website:
          type: string
          example: "https://example.com"
        specialtySkillIds:
          type: array
          items: { type: string }
          example: ["sk_11111111-1111-1111-1111-111111111111"]
        status:
          $ref: "#/components/schemas/ConsultancyStatus"
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        location:
          type: object
          required: [country, city]
          properties:
            country: { type: string, example: "UK" }
            city: { type: string, example: "London" }
            region: { type: string, nullable: true, example: "England" }
            timezone: { type: string, nullable: true, example: "Europe/London" }
        logo:
          allOf:
            - $ref: "#/components/schemas/ConsultancyLogo"
          nullable: true

    CreateConsultancyResponse:
      type: object
      required: [message, createdConsultancy]
      properties:
        message:
          type: string
          example: "Consultancy created successfully"
        createdConsultancy:
          $ref: "#/components/schemas/Consultancy"

    GetConsultanciesResponse:
      type: object
      required: [consultancies, meta]
      properties:
        consultancies:
          type: array
          items: { $ref: "#/components/schemas/Consultancy" }
        meta:
          $ref: "#/components/schemas/PaginationMeta"

    # -----------------------
    # Uploads
    # -----------------------
    LogoUploadRequest:
      type: object
      required: [filename, contentType]
      properties:
        filename: { type: string, example: "logo.png" }
        contentType: { type: string, example: "image/png" }

    LogoUploadResponse:
      type: object
      required: [uploadUrl, key, url, contentType, expiresIn]
      properties:
        uploadUrl:
          type: string
          description: Pre-signed S3 PUT URL
        key:
          type: string
          description: S3 object key to store in consultancy.logo.key
        url:
          type: string
          format: uri
          description: URL to later render logo (e.g. CloudFront URL)
        contentType:
          type: string
        expiresIn:
          type: integer
          example: 300
